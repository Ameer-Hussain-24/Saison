# 课程表网格化重构实现任务

- [x] 1. 创建数据模型和配置





- [x] 1.1 创建 CourseGridPosition 数据类

  - 定义 offsetY 和 height 属性
  - 添加到 domain/model 包
  - _需求: 2.1, 2.2, 2.3_


- [x] 1.2 创建 GridLayoutConfig 数据类

  - 定义网格布局相关的尺寸配置
  - 包含 cellHeight, columnWidths, padding 等属性
  - _需求: 1.1, 7.1, 7.2_


- [x] 1.3 扩展 CourseSettings 数据类

  - 添加 gridCellHeight, showWeekends, autoScrollToCurrentTime, highlightCurrentPeriod 字段
  - 更新序列化逻辑
  - _需求: 7.1, 6.3, 6.4_

- [x] 2. 实现核心网格组件



- [x] 2.1 创建 GridCell 组件


  - 实现单个网格单元格的UI
  - 支持空白状态和点击交互
  - 添加涟漪动画效果
  - _需求: 5.1, 5.2, 5.3, 5.4_

- [x] 2.2 创建 PeriodHeaderColumn 组件


  - 显示节次编号列("第1节", "第2节"等)
  - 实现当前节次高亮效果
  - 固定宽度布局
  - _需求: 1.2, 6.4_

- [x] 2.3 创建 TimeHeaderColumn 组件


  - 显示时间范围列("08:00-08:45"等)
  - 使用次要颜色和较小字体
  - 固定宽度布局
  - _需求: 1.3_

- [x] 2.4 创建 DayHeaderRow 组件


  - 显示星期标题("周一"到"周日")
  - 实现当前日期高亮效果
  - 固定高度布局
  - _需求: 1.5_

- [x] 2.5 创建 CourseGridCard 组件


  - 实现课程卡片UI,支持动态高度
  - 根据跨越节次数调整内容显示(名称/地点/时间)
  - 添加当前课程的脉冲动画效果
  - 实现冲突标识显示
  - _需求: 2.4, 2.5, 6.4, 8.4_

- [x] 3. 实现网格布局容器



- [x] 3.1 创建 GridDayColumn 组件


  - 实现单个工作日的网格列
  - 使用 Box 布局管理网格背景和课程卡片
  - 实现课程位置计算逻辑
  - 处理课程冲突的并排/重叠显示
  - _需求: 2.1, 2.2, 2.3, 8.5_

- [x] 3.2 创建 GridTimetableView 主组件


  - 实现整体网格布局结构
  - 集成 LazyColumn 实现垂直滚动
  - 集成水平滚动支持
  - 实现固定左侧列的叠加层效果
  - _需求: 1.1, 1.4, 6.1, 6.2_

- [x] 3.3 实现课程位置计算函数


  - 创建 calculateCoursePosition 函数
  - 根据 periodStart 和 periodEnd 计算偏移和高度
  - 添加边界检查和错误处理
  - _需求: 2.2, 2.3_

- [x] 4. 实现节次选择器


- [x] 4.1 创建 PeriodSelector 组件


  - 使用 FlowRow 布局显示所有节次
  - 实现开始节次和结束节次的选择逻辑
  - 高亮显示选中的节次范围
  - 显示已占用节次的禁用状态
  - _需求: 3.1, 3.2, 3.3_

- [x] 4.2 集成 PeriodSelector 到 AddCourseSheet

  - 替换现有的时间选择UI(在节次模式下)
  - 实现节次选择后自动填充时间
  - 保留自定义时间模式的切换功能
  - _需求: 3.4, 3.5_

- [x] 4.3 集成 PeriodSelector 到 EditCourseSheet

  - 显示当前课程的节次信息
  - 支持节次模式和自定义时间模式切换
  - 实现自动匹配最接近节次的逻辑
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5. 增强 CourseViewModel


- [x] 5.1 添加当前节次状态管理

  - 添加 currentPeriod StateFlow
  - 实现 updateCurrentPeriod 方法
  - 添加定时更新逻辑(每分钟检查一次)
  - _需求: 6.4_

- [x] 5.2 添加当前星期状态管理

  - 添加 currentDay StateFlow
  - 实现日期变化时的自动更新
  - _需求: 6.3_

- [x] 5.3 实现课程查询方法

  - 创建 getCoursesAt 方法,查询指定星期和节次的课程
  - 用于空白单元格点击时的预填充
  - _需求: 5.4_

- [x] 5.4 实现冲突检测方法

  - 创建 detectConflict 方法
  - 检测指定时间段是否与现有课程冲突
  - 返回冲突的课程列表
  - _需求: 8.1, 8.2_

- [x] 6. 实现响应式布局

- [x] 6.1 创建布局计算函数

  - 实现 calculateDayColumnWidth 函数
  - 根据屏幕宽度计算每天列的宽度
  - 确保最小宽度要求
  - _需求: 7.1, 7.2_

- [x] 6.2 实现横竖屏适配

  - 创建 getVisibleDays 函数
  - 根据屏幕方向决定显示的工作日
  - 竖屏优先显示工作日,横屏尝试显示全周
  - _需求: 7.4_

- [x] 6.3 实现水平滚动逻辑

  - 当列宽不足时启用水平滚动
  - 保持左侧节次列和时间列固定
  - _需求: 6.2, 7.2, 7.3_

- [x] 7. 实现自动滚动和导航

- [x] 7.1 实现自动滚动到当前时间

  - 在 GridTimetableView 中添加 LaunchedEffect
  - 根据 currentPeriod 自动滚动到对应位置
  - 添加平滑动画效果
  - _需求: 6.3_

- [x] 7.2 创建快速导航按钮

  - 创建 QuickNavigationFab 组件
  - 点击后滚动到当前时间
  - 只在非当前时间时显示
  - _需求: 6.5_

- [x] 7.3 实现当前课程高亮

  - 在 CourseGridCard 中添加 isCurrentlyActive 参数
  - 实现脉冲动画效果
  - _需求: 6.4_

- [x] 8. 实现冲突检测和显示

- [x] 8.1 创建 ConflictWarningCard 组件

  - 显示冲突警告信息
  - 列出冲突的课程列表
  - 提供继续保存的选项
  - _需求: 8.2, 8.3_

- [x] 8.2 集成冲突检测到添加/编辑面板

  - 在节次选择时实时检测冲突
  - 显示 ConflictWarningCard
  - 允许用户选择是否继续
  - _需求: 8.1, 8.2, 8.3_

- [x] 8.3 实现冲突课程的视觉标识

  - 在 CourseGridCard 右上角添加警告图标
  - 使用不同的边框样式标识冲突
  - _需求: 8.4_

- [x] 8.4 实现冲突课程的布局策略

  - 在 GridDayColumn 中检测每个节次的课程数量
  - 实现并排显示逻辑(空间足够时)
  - 实现重叠显示逻辑(空间不足时)
  - _需求: 8.5_

- [x] 9. 集成到 CourseScreen

- [x] 9.1 添加视图切换功能

  - 在 CourseTopBar 添加视图切换按钮
  - 在 CourseViewModel 添加视图模式状态
  - 保存用户的视图偏好到 PreferencesManager
  - _需求: 1.1_

- [x] 9.2 集成 GridTimetableView 到 CourseScreen

  - 根据视图模式显示 GridTimetableView 或 ContinuousTimelineView
  - 传递所有必要的参数和回调
  - 处理空白单元格点击事件
  - _需求: 1.1, 5.4_

- [x] 9.3 实现空白单元格点击处理

  - 点击空白单元格打开 AddCourseSheet
  - 预填充对应的星期和节次
  - _需求: 5.4, 5.5_

- [x] 10. 性能优化

- [x] 10.1 实现课程位置缓存

  - 使用 remember 缓存课程位置计算结果
  - 只在课程或节次变化时重新计算
  - _需求: 2.1, 2.2_

- [x] 10.2 实现冲突检测缓存

  - 使用 remember 缓存冲突检测结果
  - 只在课程列表变化时重新检测
  - _需求: 8.1_

- [x] 10.3 优化列表渲染

  - 为 LazyColumn 和 LazyRow 添加 key 参数
  - 使用 derivedStateOf 处理派生状态
  - _需求: 6.1, 6.2_

- [x] 11. 添加动画效果

- [x] 11.1 实现课程卡片缩放动画

  - 当前课程使用 spring 动画放大
  - 添加平滑的过渡效果
  - _需求: 6.4_

- [x] 11.2 实现当前节次高亮动画

  - 使用 infiniteTransition 实现呼吸效果
  - 应用到 PeriodHeaderColumn 的当前节次
  - _需求: 6.4_

- [x] 11.3 添加网格单元格点击动画

  - 实现涟漪效果
  - 添加触觉反馈
  - _需求: 5.3_

- [x] 12. 实现可访问性支持

- [x] 12.1 添加语义标签

  - 为 CourseGridCard 添加 contentDescription
  - 包含课程名称、星期、节次、时间信息
  - _需求: 1.1, 2.4_

- [x] 12.2 确保最小触摸目标

  - 验证所有可点击元素至少 48dp × 48dp
  - 调整课程卡片最小高度为 56dp
  - _需求: 5.3_

- [x] 12.3 优化颜色对比度

  - 使用 CourseColorUtils 确保文字可读性
  - 验证对比度 >= 4.5:1
  - _需求: 2.5_

- [x] 13. 添加配置选项

- [x] 13.1 在 CourseSettingsSheet 添加网格配置

  - 添加单元格高度滑块
  - 添加显示周末开关
  - 添加自动滚动开关
  - 添加高亮当前节次开关
  - _需求: 7.1, 6.3, 6.4_

- [x] 13.2 实现配置持久化

  - 保存配置到 PreferencesManager
  - 应用启动时加载配置
  - _需求: 7.1_

- [ ]* 14. 添加测试
- [ ]* 14.1 添加单元测试
  - 测试 calculateCoursePosition 函数
  - 测试冲突检测逻辑
  - 测试布局计算函数
  - _需求: 2.3, 8.1_

- [ ]* 14.2 添加UI测试
  - 测试 GridTimetableView 显示
  - 测试节次选择器交互
  - 测试空白单元格点击
  - _需求: 1.1, 3.1, 5.4_

- [x] 15. 文档和清理


- [x] 15.1 添加代码注释

  - 为所有新组件添加 KDoc 注释
  - 说明关键算法的实现逻辑
  - _需求: 所有_

- [x] 15.2 更新用户文档

  - 在 README 中添加网格视图使用说明
  - 说明节次选择器的使用方法
  - _需求: 1.1, 3.1_

- [x] 15.3 清理未使用代码

  - 如果完全替换旧视图,移除 ContinuousTimelineView
  - 清理相关的辅助函数和数据类
  - _需求: 1.1_
